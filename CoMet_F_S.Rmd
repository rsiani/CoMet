---
title: "Comparative Metataxonomy: Fatma & Sarah"
author: "Roberto Siani"
date: "30/09/2021"
---

PROJECT NOTES:
insert short intro to project here

# SETUP

Set up working environment: packages and default graphic themes.

```{r, cache = TRUE, echo = FALSE, include = FALSE}

# pacman to install and load libraries

if (!require("pacman")) {
  install.packages(
    "pacman",
    verbose = F
  )
}

# and BiocManager for Bioconductor libraries

if (!require("BiocManager")) {
  install.packages(
    "BiocManager",
    verbose = F
  )
}

# install/load GitHub libraries

pacman::p_load_gh(
  "jbisanz/qiime2R",
  "benjjneb/decontam",
  "mikemc/speedyseq",
  "adw96/breakaway",
  "adw96/DivNet"
)

# install/load CRAN/BioConductor libraries

pacman::p_load(
  tidyverse,
  vegan,
  ape,
  microbiome,
  ggpubr,
  patchwork,
  hrbrthemes,
  phangorn,
  DECIPHER,
  MicrobiotaProcess,
  hues,
  ggtree,
  ggridges,
  ANCOMBC
)

# load sensible themes and palettes (from a separate script!)

source("~/Desktop/library/scripts/helpeR.R")

# define functions

select = dplyr::select
transform = microbiome::transform

```

# PRE-PROCESS

## SELECT PATHS

```{r}

metadata_table = "mapping.csv"

taxonomic_assignment = "taxa_table.tsv"

counts_table = "count_table.tsv"

control_samples = c("extneg", "pcrneg")

```


## PRE-PROCESS TO PHYLOSEQ OBJECT

```{r}

# import metadata

metaTab =
  read_csv(metadata_table) %>%
  mutate_if(is_character, as.factor)

# import and clean taxonomy

raw_taxTab =
  read_tsv(taxonomic_assignment) %>%
  map_df(~ gsub(
    pattern = "metagenome|uncultured|unidentified|Unknown",
    replacement = NA,
    .x
  )) %>%
  mutate_if(is_character, str_trim) %>%
  mutate(
    Domain = ifelse(is.na(Domain),
                    "U. Domain",
                    Domain
    ),
    Phylum = coalesce(
      Phylum,
      ifelse(grepl("^U.", Domain),
        Domain,
        paste("U.", Domain)
      )
    ),
    Class = coalesce(
      Class,
      ifelse(grepl("^U.", Phylum),
        Phylum,
        paste("U.", Phylum)
      )
    ),
    Order = coalesce(
      Order,
      ifelse(grepl("^U.", Class),
        Class,
        paste("U.", Class)
      )
    ),
    Family = coalesce(
      Family,
      ifelse(grepl("^U.", Order),
        Order,
        paste("U.", Order)
      )
    ),
    Genus = coalesce(
      Genus,
      ifelse(grepl("^U.", Family),
        Family,
        paste("U.", Family)
      )
    ),
    Species = coalesce(
      Species,
      ifelse(grepl("^U.", Genus),
        Genus,
        paste("U.", Genus)
      )
    )
  ) %>%
  column_to_rownames("ASV") %>%
  filter(Domain %in% "Bacteria" &
    !Order %in% "Chloroplast" &
    !Family %in% "Mitochondria")

# import counts table

raw_abuTab =
  read_tsv(counts_table) %>%
  `colnames=`(gsub("Fatma", "", colnames(.))) %>%
  `colnames=`(gsub("_.*", "", colnames(.))) %>%
  column_to_rownames("ASV")

# reads per sample

summary((colSums(raw_abuTab)))

# clean counts table

abuTab =
  raw_abuTab %>%
  filter(!rownames(.) %in%
    isContaminant(
      as.matrix(.),
      neg = c(colnames(.) %in%
        control_samples),
      threshold = .1,
      normalize = T,
      detailed = F
    )) %>%
  select_if(!names(.) %in% control_samples) %>%
  filter(rowSums(.) > 0 &
    rownames(.) %in% rownames(raw_taxTab))

# clean reads per sample

summary((colSums(abuTab)))

# filtered reads

colSums(raw_abuTab) - c(0, 0, colSums(abuTab))

# final cleaning of taxonomy table

taxTab =
  raw_taxTab %>%
  filter(rownames(.) %in%
    rownames(abuTab)) %>%
  as.matrix()

# multi-alignment to predict phylogenetic tree
# this step is long and not always necessary

treeObj =
  phyDat(
    as(
      AlignSeqs(
        DNAStringSet(
          x = rownames(abuTab) %>%
            set_names(),
          use.names = T
        ),
        anchor = NA,
        verbose = F
      ),
      "matrix"
    ),
    type = "DNA"
  ) %>%
  pml(dist.ml(.) %>%
    NJ(),
  data = .
  ) %>%
  optim.pml(.)

# import into phyloseq-object

meCom =
  phyloseq(
    otu_table(abuTab,
      taxa_are_rows = T
    ),
    tax_table(taxTab),
    sample_data(metaTab %>%
      column_to_rownames("ID")),
    phy_tree(treeObj$tree)
  )

# create directory for results
dir.create("OUT")

# save phyloseq-class object

save(meCom,
  file = paste("meCom",
    format(Sys.time(), "_%d%m%y_%H%M"),
    ".RData",
    sep = ""
  )
)

```

# INPUT

```{r, echo = FALSE, include = FALSE}

# load your meCom dataset

load("~/Desktop/300921_sarah_fatma/uBiome_031121_1108.RData")

# check your summary

summarize_phyloseq(meCom)

# check if you have low depth samples to discard!

sort(colSums(meCom@otu_table))

# it looks like sample R20 should be discarded

meCom = 
  prune_samples(c(sample_names(meCom) != "R20"), meCom)

# control again

summarize_phyloseq(meCom)

# define a color palette for data viz

palette_list =
  list(
    Rootstock = c("#9DE0AD", "#45ADA8", "#547980")
  )

map(
  palette_list,
  ~ swatches::show_palette(.x)
)

# check that all levels are approximately equal

table(meta(meCom)$Soil, 
      meta(meCom)$Rootstock)

```

# OUTPUT 

## MICROBIOME OVERVIEW

### General stats

```{r}

# for heavily left-skewed dataset, you might want to filter out some rare taxa

prevFilt =
  meCom %>%
  metagMisc::phyloseq_filter_prevalence(
    prev.trh = 3 / nsamples(meCom),
    abund.trh = 100,
    threshold_condition = "OR",
    abund.type = "total"
  )

ntaxa(meCom)

ntaxa(prevFilt)

# just some operations to get an overview of your metacommunity

sum_df =
  prevFilt %>%
  transform("clr") %>%
  speedyseq::psmelt() %>%
  group_by_at(vars(-Abundance, -Sample, -Soil, -Rootstock)) %>%
  summarise(
    CLR_mean = mean(Abundance),
    CLR_SD = sd(Abundance)
  ) %>%
  ungroup() %>%
  mutate(
    TRA = taxa_sums(prevFilt %>%
      transform("compositional")),
    Prevalence =
      prevalence(prevFilt, count = T),
    Phylum = as.factor(Phylum)
  )

# scatter plot of abundances against standard deviation

plot_1 =
  ggplot(
    sum_df,
    aes(
      x = CLR_mean,
      y = CLR_SD,
      color = Phylum
    )
  ) +
  geom_point(aes(
    alpha = Prevalence,
    size = TRA
  ),
  size = 1,
  shape = 19
  ) +
  theme(legend.position = "none") +
  scale_color_iwanthue(
    hmin = 0,
    hmax = 360,
    cmin = 20,
    cmax = 50,
    lmin = 50,
    lmax = 100
  ) +
  facet_wrap(~Phylum) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    strip.text.x = element_text(size = 12)
  ) +
  labs(
    x = "Abundance",
    y = "SD"
  )

# density ridges of prevalence per phylum

plot_2 =
  ggplot(
    sum_df,
    aes(Prevalence,
      y = Phylum,
      fill = Phylum,
      color = Phylum
    )
  ) +
  geom_density_ridges(
    alpha = 1 / 4,
    size = 0.5
  ) +
  theme(legend.position = "none") +
  scale_color_iwanthue(
    hmin = 0,
    hmax = 360,
    cmin = 20,
    cmax = 50,
    lmin = 50,
    lmax = 100,
    aesthetics = c("fill", "color")
  ) +
  xlim(c(0, nsamples(meCom)))

cairo_pdf("OUT/overlook_filtered.pdf",
  width = 24,
  height = 16
)
plot_1 + plot_2 + plot_layout(widths = c(2, 1))
dev.off()

# tree, because we all like trees

plot_3 =
  ggtree(meCom %>%
    transform("compositional"),
  layout = "fan",
  open.angle = 10,
  size = 0.1
  ) +
  geom_rootedge(0.1,
    size = 0.1
  ) +
  geom_tippoint(
    aes(
      color = Phylum,
      size = Abundance,
      alpha = Abundance
    ),
    shape = 19
  ) +
  scale_color_iwanthue(
    hmin = 0,
    hmax = 360,
    cmin = 20,
    cmax = 50,
    lmin = 50,
    lmax = 100,
    aesthetics = c("fill", "color")
  )

cairo_pdf("OUT/tree.pdf",
  width = 16,
  height = 16
)
plot_3
dev.off()

# in case you want to continue with the filtered dataset, do this!

meCom =
  prevFilt

```

### Relative Abundance

```{r}

# function for relative abundance

plotRelativeAbundance = function(level, thresh, var1, var2) {
  meCom %>%
    transform("compositional") %>%
    speedyseq::psmelt() %>%
    group_by(
      {{ var1 }},
      {{ var2 }},
      {{ level }}
    ) %>%
    summarise(Abundance = sum(Abundance)) %>%
    mutate(taxa = ifelse(
      Abundance >= quantile(Abundance, thresh),
      {{ level }},
      paste("below q", thresh, sep = "")
    )) %>%
    ggplot() +
    geom_bar(
      stat = "identity",
      position = "fill",
      aes(
        x = {{ var1 }},
        y = Abundance,
        fill = taxa
      )
    ) +
    scale_fill_iwanthue(
      hmin = 0,
      hmax = 360,
      cmin = 20,
      cmax = 50,
      lmin = 25,
      lmax = 100,
      random = T
    ) +
    facet_wrap(vars({{ var2 }}),
      scales = "free_x"
    ) +
    theme(
      legend.position = "right",
      axis.title.x = element_blank(),
      legend.key = element_rect(
        size = 0,
        linetype = 0
      ),
      axis.title.y = element_blank()
    )
}

# plot relative abundance per Phylum, grouping Phyla below the X quantile and displayed by var1 and var2 ()

plot_4 =
  plotRelativeAbundance(Phylum, 0.8, Rootstock, Soil)

# save all in a pdf

cairo_pdf("OUT/relativeAbundance.pdf",
  width = 16,
  height = 16,
  onefile = T
)
plot_4
dev.off()

```


## DIVERSITY

### Richness and Alpha Diversity

Here we switch from plug-in to estimated measures of diversity (Shannon, Simpson)

```{r}

res_breakaway =
  breakaway(meCom) %>% 
  summary() %>% 
  as_tibble() %>% 
  left_join(meta(meCom) %>% 
              rownames_to_column("sample_names"))


a =
  ggplot(
    data = res_breakaway,
    aes(
      x = Rootstock,
      y = estimate,
      fill = Rootstock
    )
  ) +
  geom_boxplot(size = 0.5) +
  scale_fill_manual(values = palette_list$Rootstock) +
  ylab("breakaway estimate") +
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    panel.grid.major.x = element_blank()
  ) +
  geom_signif(
    comparisons = list(
      c("AR10-3-9", "CG935"),
      c("AR10-3-9", "M26"),
      c("M26", "CG935")
    ),
    map_signif_level = F,
    tip_length = 0,
    test = "wilcox.test",
    step_increase = 0.05
  )

# your design matrix

des_mat =
  model.matrix(~ Rootstock + Soil, data = meta(meCom))

# calculate diversity estimates for your samples

set.seed(666)

res_divnet =
  meCom %>%
  divnet(
    ncores = parallel::detectCores(),
    tuning = "fast")

# group results

alpha_diversity_estimates =
  map(
    c("shannon", "simpson") %>%
      set_names(),
    ~ res_divnet %>%
      pluck(.x) %>%
      summary() %>%
      left_join(meta(meCom) %>%
        rownames_to_column("sample_names"),
      by = "sample_names"
      )
  )

# shannon estimates boxplot

b = ggplot(
  data = alpha_diversity_estimates$shannon,
  aes(
    x = Rootstock,
    y = estimate,
    fill = Rootstock
  )
) +
  geom_boxplot(size = 0.5) +
  scale_fill_manual(values = palette_list$Rootstock) +
  ylab("shannon estimate") +
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    panel.grid.major.x = element_blank()
  ) +
  geom_signif(
    comparisons = list(
      c("AR10-3-9", "CG935"),
      c("AR10-3-9", "M26"),
      c("M26", "CG935")
    ),
    map_signif_level = F,
    tip_length = 0,
    test = "wilcox.test",
    step_increase = 0.05
  )

# simpson estimates boxplot

c = ggplot(
  data = alpha_diversity_estimates$simpson,
  aes(
    x = Rootstock,
    y = estimate,
    fill = Rootstock
  )
) +
  geom_boxplot(size = 0.5) +
  scale_fill_manual(values = palette_list$Rootstock) +
  ylab("simpson estimate") +
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    panel.grid.major.x = element_blank()
  ) +
  geom_signif(
    comparisons = list(
      c("AR10-3-9", "CG935"),
      c("AR10-3-9", "M26"),
      c("M26", "CG935")
    ),
    map_signif_level = F,
    tip_length = 0,
    test = "wilcox.test",
    step_increase = 0.05
  )

# all together

plot_5 =
  a + b + c +
  plot_layout(guides = "collect")

cairo_pdf("OUT/alphaDiversity.pdf",
  width = 16,
  height = 16,
  onefile = T
)
plot_5
dev.off()

## hypothesis testing

res_simpson =
  testDiversity(res_divnet,
    h0 = "simpson"
  )

#  p-value for global test: 2.6132296326864e-10

res_shannon =
  testDiversity(res_divnet,
    h0 = "shannon"
  )

# p-value for global test: 0 

```

### Beta Diversity

```{r}

## testing differences in distance

res_means =
  compare_means(
    value ~ Rootstock,
    data = phyloseq::distance(meCom %>%
      transform("clr"), "euclidean") %>%
      as.matrix() %>%
      as.data.frame() %>%
      rownames_to_column("sample_id") %>%
      left_join(meta(meCom) %>%
        rownames_to_column("sample_id")) %>%
      pivot_longer(2:(nsamples(meCom) + 1)),
    method = "wilcox.test",
    p.adjust.method = "BH",
    group.by = "Soil"
  )

write_tsv(res_means, "OUT/aitchison_wilcox.tsv")

## DivNet hypothesis testing (doesn't always work)

source("~/Desktop/library/scripts/helper_testBeta.R")

bc_test =
  testBetaDiversity(res_divnet,
    h0 = "bray-curtis",
    n_boot = 10e3,
    sample_specimen_matrix = des_mat,
    groups = sample_data(meCom)$Rootstock
  )


bc_test$p_value ## 0.76

euc_test =
  testBetaDiversity(res_divnet,
    h0 = "euclidean",
    n_boot = 999,
    sample_specimen_matrix = res_divnet$X,
    groups = meta(meCom)$Rootstock
  )

euc_test$p_value

ait_test =
  testBetaDiversity(res_divnet,
    h0 = "aitchison",
    sample_specimen_matrix = res_divnet$X,
    n_boot = 999,
    groups = meta(meCom)$Rootstock
  )

ait_test$p_value

## PCA 

res_prcomp =
  prcomp(
    meCom %>% 
      abundances("clr") %>%
      t()
  )

plot_6 =
  res_prcomp$x %>%
  as.data.frame() %>%
  rownames_to_column("sample_names") %>%
  left_join(meta(meCom) %>%
    rownames_to_column("sample_names")) %>%
  ggplot(
    aes(
      x = PC1,
      y = PC2
    )
  ) +
  geom_point(
    aes(
      group = Rootstock,
      color = Rootstock,
      shape = Soil
    ),
    size = 5
  ) +
  scale_shape_manual(values = c(1, 2)) +
  stat_ellipse(
    linetype = 0,
    geom = "polygon",
    type = "norm",
    alpha = 0.05,
    aes(fill = Rootstock)
  ) +
  scale_color_manual(
    values = palette_list$Rootstock,
    aesthetics = c("fill", "color")
  ) +
  labs(
    x = paste("Dim. 1,", round(res_prcomp$sdev[1]^2 / sum(res_prcomp$sdev^2), 2)),
    y = paste("Dim. 2,", round(res_prcomp$sdev[2]^2 / sum(res_prcomp$sdev^2), 2))
  ) +
  theme(legend.position = "right") +
  geom_point(
    data =
      res_prcomp$x %>%
        as.data.frame() %>%
        rownames_to_column("sample_names") %>%
        left_join(meta(meCom) %>%
          rownames_to_column("sample_names")) %>%
        filter(Soil %in% "ARD+") %>%
        group_by(Rootstock) %>%
        summarise(
          PC1 = mean(PC1),
          PC2 = mean(PC2)
        ),
    aes(
      x = PC1,
      y = PC2,
      color = Rootstock
    ),
    size = 3,
    shape = 19
  ) +
  geom_polygon(
    data =
      res_prcomp$x %>%
        as.data.frame() %>%
        rownames_to_column("sample_names") %>%
        left_join(meta(meCom) %>%
          rownames_to_column("sample_names")) %>%
        filter(Soil %in% "ARD+") %>%
        group_by(Rootstock) %>%
        summarise(
          PC1 = mean(PC1),
          PC2 = mean(PC2)
        ) %>%
        mutate(group = "temp"),
    aes(
      x = PC1,
      y = PC2,
      group = group
    ),
    alpha = 0,
    fill = "white",
    color = "#aaaaaa",
    size = 0.5,
    linetype = "dotted"
  )

cairo_pdf("OUT/PCA_ARD.pdf",
  width = 16,
  height = 16
)
plot_6
dev.off()

```

## DIFFERENTIAL ABUNDANCE

### ANCOM-BC

```{r}

# create unique identifier for Genus

new_tax_table = 
  meCom@tax_table@.Data %>% 
  as.data.frame() %>% 
  mutate(Genus = vctrs::vec_as_names(Genus, repair = "unique") %>% 
           sub("...", "_", fixed = T, .))

# workaround for something I dindn't have the patience for

meCom_id = 
  phyloseq(
    otu_table(meCom@otu_table, taxa_are_rows = T),
    sample_data(meCom@sam_data),
    phy_tree(meCom@phy_tree),
    tax_table(new_tax_table %>% 
                as.matrix))

## M26 vs AR10-3-9

res_MvA =
  ancombc(meCom_id %>%
    subset_samples(Rootstock != "CG935") %>%
    prune_taxa(taxa_sums(.) > 0, .),
  formula = "Rootstock",
  p_adj = "fdr",
  zero_cut = 1,
  conserve = T
  )

res_MvA_df =
  res_MvA$res$beta %>%
  as.data.frame() %>%
  rownames_to_column("ASV") %>%
  left_join(
    res_MvA$res$q_val %>%
      as.data.frame() %>%
      rownames_to_column("ASV"),
    by = "ASV",
    suffix = c("_beta", "_q")
  ) %>% 
  left_join(
    res_MvA$res$W %>% 
      as.data.frame() %>% 
      rownames_to_column("ASV")) %>% 
  dplyr::rename(RootstockM26_W = RootstockM26) %>% 
  mutate(RootstockM26_DA = as.factor(case_when(
    RootstockM26_q > 0.01 & RootstockM26_q <= 0.05 ~ "*",
    RootstockM26_q > 0.001 & RootstockM26_q <= 0.01 ~ "**",
    RootstockM26_q > 0.0001 & RootstockM26_q <= 0.001 ~ "***",
    RootstockM26_q <= 0.0001 ~ "****",
    TRUE ~ "ns"
  ))) %>% 
  pivot_longer(-ASV,
    names_to = c("var", ".value"),
    names_sep = "_") %>% 
  mutate(var = factor(var, levels = c("RootstockM26"), 
                      labels = c("= AR10-3-9|M26 ->")))

res_MvA_df$DA = relevel(res_MvA_df$DA, ref = "ns")

relAbu_MvA_df = 
  res_MvA_df %>%
  filter(q <= 0.05) %>% 
  left_join(tax_table(meCom_id) %>% 
              as.data.frame() %>% 
              rownames_to_column("ASV"))

## M26 vs CG935

res_MvC =
  ancombc(meCom_id %>%
    subset_samples(Rootstock != "AR10-3-9") %>%
    prune_taxa(taxa_sums(.) > 0, .),
  formula = "Rootstock",
  p_adj = "fdr",
  zero_cut = 1,
  conserve = T,
  )

res_MvC_df =
  res_MvC$res$beta %>%
  as.data.frame() %>%
  rownames_to_column("ASV") %>%
  left_join(
    res_MvC$res$q_val %>%
      as.data.frame() %>%
      rownames_to_column("ASV"),
    by = "ASV",
    suffix = c("_beta", "_q")
  ) %>% 
  left_join(
    res_MvC$res$W %>% 
      as.data.frame() %>% 
      rownames_to_column("ASV")) %>% 
  dplyr::rename(RootstockM26_W = RootstockM26) %>% 
  mutate(RootstockM26_DA = as.factor(case_when(
    RootstockM26_q > 0.01 & RootstockM26_q <= 0.05 ~ "*",
    RootstockM26_q > 0.001 & RootstockM26_q <= 0.01 ~ "**",
    RootstockM26_q > 0.0001 & RootstockM26_q <= 0.001 ~ "***",
    RootstockM26_q <= 0.0001 ~ "****",
    TRUE ~ "ns"
  ))) %>% 
  pivot_longer(-ASV,
    names_to = c("var", ".value"),
    names_sep = "_") %>% 
  mutate(var = factor(var, levels = c("RootstockM26"), 
                      labels = c("= CG935|M26 ->")))

res_MvC_df$DA = relevel(res_MvC_df$DA, ref = "ns")

relAbu_MvC_df = 
  res_MvC_df %>%
  filter(q <= 0.05) %>% 
  left_join(tax_table(meCom_id) %>% 
              as.data.frame() %>% 
              rownames_to_column("ASV"))

## CG935 vs AR10-3-9

res_AvC =
  ancombc(meCom_id %>%
    subset_samples(Rootstock != "M26") %>%
    prune_taxa(taxa_sums(.) > 0, .),
  formula = "Rootstock",
  p_adj = "fdr",
  zero_cut = 1,
  conserve = T
  )

res_AvC_df =
  res_AvC$res$beta %>%
  as.data.frame() %>%
  rownames_to_column("ASV") %>%
  left_join(
    res_AvC$res$q_val %>%
      as.data.frame() %>%
      rownames_to_column("ASV"),
    by = "ASV",
    suffix = c("_beta", "_q")
  ) %>% 
  left_join(
    res_AvC$res$W %>% 
      as.data.frame() %>% 
      rownames_to_column("ASV")) %>% 
  dplyr::rename(RootstockCG935_W = RootstockCG935) %>% 
  mutate(RootstockCG935_DA = as.factor(case_when(
    RootstockCG935_q > 0.01 & RootstockCG935_q <= 0.05 ~ "*",
    RootstockCG935_q > 0.001 & RootstockCG935_q <= 0.01 ~ "**",
    RootstockCG935_q > 0.0001 & RootstockCG935_q <= 0.001 ~ "***",
    RootstockCG935_q <= 0.0001 ~ "****",
    TRUE ~ "ns"
  ))) %>% 
  pivot_longer(-ASV,
    names_to = c("var", ".value"),
    names_sep = "_") %>% 
  mutate(var = factor(var, levels = c("RootstockCG935"), 
                      labels = c("= AR10-3-9|CG935 ->")))

res_AvC_df$DA = relevel(res_AvC_df$DA, ref = "ns")

relAbu_AvC_df = 
  res_AvC_df %>%
  filter(q <= 0.05) %>% 
  left_join(tax_table(meCom_id) %>% 
              as.data.frame() %>% 
              rownames_to_column("ASV"))

# group everything together for the plotting

res_df = 
  rbind(res_AvC_df, res_MvA_df, res_MvC_df)

plot_7 =
  ggplot(
    res_df
  ) +
  geom_point(
    aes(
      x = beta,
      y = W,
      color = DA,
      alpha = DA
    ),
    size = 2,
    shape = 19
  ) +
  scale_color_manual(values = michelangelo$grad3) +
  facet_wrap(~var) +
  theme(legend.position = "right") +
  scale_alpha_discrete(range = c(0.2, 1))

relAbu_df =
  rbind(relAbu_AvC_df, relAbu_MvC_df, relAbu_MvA_df)

plot_8 = 
  relAbu_df  %>% 
  ggplot() +
  geom_bar(aes(y = fct_reorder(Genus, W),
               x = W, 
               fill = Family),
           stat = "identity",
           position = "dodge") +
  scale_fill_iwanthue(hmin = 0,
                      hmax = 360,
                      cmin = 0,
                      cmax = 30,
                      lmin = 50,
                      lmax = 75) +
  theme(axis.text.y = element_text(size = 12),
        axis.title.y = element_blank(),
        legend.position = "right",
        strip.text = element_blank()) +
  guides(fill = guide_legend(ncol = 1)) +
  facet_wrap(~var) +
  geom_vline(xintercept = 0,
             size = 0.5,
             color = "#696969")

cairo_pdf("OUT/ANCOMBC.pdf",
  width = 24,
  height = 16,
  onefile = T
)
plot_7 / plot_8
dev.off()

```


## WORK IN PROGRESS

### NETWORKS

```{r}

p_load_gh(
  "stefpeschel/NetCoMi",
  "vmikk/metagMisc"
)

meCom_split =
  phyloseq_sep_variable(
    meCom_t2,
    "Rootstock"
  )

net_ct =
  netConstruct(
    data = meCom_split$Control,
    data2 = meCom_split$Treatment,
    filtTax = "numbSamp",
    measure = "spieceasi",
    zeroMethod = "pseudo",
    normMethod = "clr",
    sparsMethod = "t-test",
    filtTaxPar = list(numbSamp = 2)
  )

glommed =
  meCom %>%
  tax_glom("Phylum")
View(glommed)
net_ct =
  netConstruct(glommed,
    measure = "spieceasi",
    zeroMethod = "pseudo",
    normMethod = "clr",
    sparsMethod = "threshold",
    thresh = .3
  )
```

